{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/til61","result":{"data":{"markdownRemark":{"id":"8458f859-2791-5dc5-a48d-e7ad53ba8bd5","html":"<h3 id=\"카페24-sms-발송-api-이용하기\" style=\"position:relative;\"><a href=\"#%EC%B9%B4%ED%8E%9824-sms-%EB%B0%9C%EC%86%A1-api-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"카페24 sms 발송 api 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>카페24 SMS 발송 API 이용하기</h3>\n<p>파이썬으로 구현한 카페24 SMS API 예시는 블로그 글 딱 1개밖에 없어서 카페24에서 제공하는 PHP 소스 예제를 참고해 더듬더듬 구현했다.</p>\n<p>인증문자 발신 번호, 시크릿 키 등의 정보는 my_settings.py에 저장해두고 settings.py에 연결해준 뒤 views.py에서는 settings.py를 끌어와서 사용했다. 각 코드 설명은 코드블럭 내 주석으로 달았다.</p>\n<p>(가독성 있게 바꿔야겠다…)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 인증문자 발송용 뷰</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SMSVerificationView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># send_verification 메소드 아래 post 메소드가 먼저 살행된다.</span>\n  <span class=\"token comment\"># 프론트에서 request body에 담아 인증문자 수신인 번호를 보내주면</span>\n  <span class=\"token comment\"># randint로 생성한 랜덤 인증번호를 수신인 번호로 보내는 것이 send_verification 메소드 역할이다.</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">send_verification</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> rphone<span class=\"token punctuation\">,</span> verification_number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># sms를 발송하는 카페24 url을 적어준다.</span>\n    sms_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://sslsms.cafe24.com/sms_sender.php'</span>\n    <span class=\"token comment\"># 카페24에서는 base64 인코딩을 '권장'한다고 하나, 인코딩을 하지 않았더니 아예 문자 발송이 되지 않았다.</span>\n    <span class=\"token comment\"># 권장이 아니라 필수인듯 하다.</span>\n    <span class=\"token comment\"># base64로 인코딩을 하려고 하니 string type말고 bytes type이어야 한다고 에러가 났다.</span>\n    <span class=\"token comment\"># 따라서 base64 인코딩 전에 utf-8로 인코딩을 해 bytes type으로 만들었다.</span>\n    user_id <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>SMS_SENDER_ID<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    secure <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>SECURE_KEY<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    mode <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 인증문자 발신 번호는 세 개 또는 두 개 변수에 나눠서 담아야 한다.</span>\n    <span class=\"token comment\"># 1588-0000 형태라면 sphone1, sphone2까지, 070-0000-0000 형태라면 sphone3까지 총 3개 변수에 할당한다.</span>\n    <span class=\"token comment\"># 인덱스를 이용해 하나씩 할당해주기 위해서 my_settings.py에 아예 리스트 형태로 발신 번호를 저장해놓았다.</span>\n    <span class=\"token comment\"># 예 - SMS_SENDER_NUMBER = [070, 0000, 0000]</span>\n    sphone1 <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>SMS_SENDER_NUMBER<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    sphone2 <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>SMS_SENDER_NUMBER<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    sphone3 <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>SMS_SENDER_NUMBER<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 수신인 번호 또한 인코딩해준다.</span>\n    <span class=\"token comment\"># 카페24 가이드에 따르면 010-1234-1234 형태로 하이픈을 포함해야 한다고 하나,</span>\n    <span class=\"token comment\"># 01012341234 형태로 해도 인증문자를 수신하는 것을 확인했다.</span>\n    rphone <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>rphone<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 인증문자 메시지 내용을 작성한다. verification_number는 아래 post 메소드에서 넘겨받은 것이다.</span>\n    msg <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'인증번호 [</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>verification_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">]를 입력해주세요.'</span></span>\n    <span class=\"token comment\"># 메시지 내용 또한 인코딩해준다.</span>\n    msg <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 테스트를 할 때마다 실제 문자를 발송하면 과금 부담이 있으므로 testflag = 'Y'로 해주고</span>\n    <span class=\"token comment\"># 아래 json 형태의 data에 'testflag' 항목을 포함한다.</span>\n    <span class=\"token comment\"># 'Y' 또한 인코딩 해야한다.</span>\n    testflag <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span><span class=\"token string\">'Y'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 위에서 변수에 할당해 인코딩한 것을 그대로 넣어준다.</span>\n    data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">'user_id'</span><span class=\"token punctuation\">:</span> user_id<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'secure'</span><span class=\"token punctuation\">:</span> secure<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'mode'</span><span class=\"token punctuation\">:</span> mode<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone1'</span><span class=\"token punctuation\">:</span> sphone1<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone2'</span><span class=\"token punctuation\">:</span> sphone2<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone3'</span><span class=\"token punctuation\">:</span> sphone3<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'rphone'</span><span class=\"token punctuation\">:</span> rphone<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> msg<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'testflag'</span> <span class=\"token punctuation\">:</span> testflag\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\"># testflag Y 상태에서는 문자가 실제로는 발송되지 않으므로</span>\n    <span class=\"token comment\"># 인증번호를 확인하기 위해서는 print로 찍어봐야 한다.</span>\n    <span class=\"token comment\"># 인코딩 과정과는 반대로, base64 디코딩 - utf-8 디코딩 순서로 디코딩해준다.</span>\n    <span class=\"token comment\"># 디코딩 하지 않으면 내용을 제대로 볼 수 없다.</span>\n    decoded_data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">'user_id'</span> <span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'secure'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>secure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'mode'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone1'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>sphone1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone2'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>sphone2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'sphone3'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>sphone3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'rphone'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>rphone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'testflag'</span> <span class=\"token punctuation\">:</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>testflag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\"># 내용을 확인하기 위해 print를 찍어준다. 오로지 테스트용도다.</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>decoded_data<span class=\"token punctuation\">)</span> \n\n    <span class=\"token comment\"># 위에서 작성한 data를 카페24 sms 전송 url로 전달한다.</span>\n    <span class=\"token comment\"># 카페24 sms 전송 api의 status code에 맞는 status code가 HttpResponse 형태로 리턴된다.    </span>\n    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>sms_url<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 유저가 본인 휴대전화 번호를 입력 후 '인증받기' 버튼을 눌렀을 때</span>\n<span class=\"token comment\"># 백엔드 서버가 그 정보를 받아 휴대전화 번호와 랜덤으로 생성된 인증문자를 DB에 저장하기 위한 메소드다.</span>\n<span class=\"token comment\"># DB에 저장한 휴대전화와 인증번호 정보와 유저가 입력한 인증번호가 일치하는지 여부는</span>\n<span class=\"token comment\"># 별도 뷰(SMSVerificationConfirmView)에서 확인한다.</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    data                <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n    member_phone        <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'phoneNumber'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 6자리 인증번호 랜덤 생성</span>\n    verification_number <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>randint<span class=\"token punctuation\">(</span><span class=\"token number\">100000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 같은 휴대전화 번호로 여러 번 인증할 수 있는데,</span>\n    <span class=\"token comment\"># 이때마다 새로운 row를 생성해서 저장하면 안 되므로</span>\n    <span class=\"token comment\"># 휴대전화 번호가 존재하는지 여부를 확인해서 존재한다면 update로 처리해 인증번호만 갈아끼워 저장한다.</span>\n    Verification<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>update_or_create<span class=\"token punctuation\">(</span>\n      member_phone <span class=\"token operator\">=</span> member_phone<span class=\"token punctuation\">,</span>\n      defaults     <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">'member_phone'</span>        <span class=\"token punctuation\">:</span> member_phone<span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'verification_number'</span> <span class=\"token punctuation\">:</span> verification_number\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 휴대전화번호와 인증번호를 담아 같은 클래스 내 send_verification 메소드를 호출한다.</span>\n    <span class=\"token comment\"># member_phone과 verification_number가 send_verification 메소드의 인자가 된다.</span>\n    self<span class=\"token punctuation\">.</span>send_verification<span class=\"token punctuation\">(</span>\n        rphone              <span class=\"token operator\">=</span> member_phone<span class=\"token punctuation\">,</span>\n        verification_number <span class=\"token operator\">=</span> verification_number\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">except</span> KeyError<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> JsonResponse<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'message'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'Invalide key'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이제 유저가 인증번호 확인란에 입력한 숫자가 발송한 숫자와 일치하는지 확인해야한다. 일치한다면 회원 테이블에 우선 휴대전화번호를 저장해두고 회원가입 뷰에서 나머지 정보를 업데이트하는 방식으로 구현했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SMSVerificationConfirmView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 유저가 입력한 휴대전화번호와 인증번호를 전달받는다.</span>\n    data                <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n    member_phone        <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'phoneNumber'</span><span class=\"token punctuation\">]</span>\n    verification_number <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'verificationNumber'</span><span class=\"token punctuation\">]</span>\n    \n    <span class=\"token comment\"># randint로 생성해서 DB에 저장해뒀던 인증번호와 입력한 인증번호가 일치하고,</span>\n    <span class=\"token keyword\">if</span> verification_number <span class=\"token operator\">==</span> Verification<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>\n      member_phone<span class=\"token operator\">=</span>member_phone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>verification_number<span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># 이미 가입한 휴대전화번호가 아니라면,</span>\n      <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> Member<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>member_phone<span class=\"token operator\">=</span>member_phone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 회원정보 테이블에 휴대전화번호를 저장한다.</span>\n        Member<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>member_phone<span class=\"token operator\">=</span>member_phone<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>위에서 먼저 저장한 휴대전화번호로 유저를 특정해 나머지 정보(아이디(여기선 이메일), 비밀번호 등)를 해당 row에 업데이트 한다.</p>\n<p>약관 동의 부분을 어떻게 처리할지 고민을 많이 했다. 일단 현재는 모든 약관이 필수 동의 약관이고 약관 개수가 2개로 고정돼있기 때문에 프론트로부터 동의한 약관 id(PK)값을 list 형태로 받아 처리하는 방식으로 구현했다. 아직도 어떤 방법이 베스트인지는 모르는 상태다. 장고에서 약관 동의를 다루는 케이스는 대부분 form, template를 백에서 작성하는 케이스라 내 경우에 적용할 수 없었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberSignUpView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    data               <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 비밀번호 유효성 검사</span>\n    <span class=\"token comment\"># 6~16자 사이, 영숫자 모두 포함</span>\n    password_validator <span class=\"token operator\">=</span> RegexValidator<span class=\"token punctuation\">(</span>\n      regex<span class=\"token operator\">=</span><span class=\"token string\">\"^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{6,16}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># 모든 약관에 반드시 동의해야 가입이 가능하므로 약관 동의 여부를 받아 DB에 저장해야한다.</span>\n      member_email <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'email'</span><span class=\"token punctuation\">]</span>\n      validate_email<span class=\"token punctuation\">(</span>member_email<span class=\"token punctuation\">)</span>\n      terms_id <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'termsId'</span><span class=\"token punctuation\">]</span>\n\n      <span class=\"token comment\"># 이미 가입한 회원이 아니라면,</span>\n      <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> Member<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>member_email<span class=\"token operator\">=</span>member_email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        password_validator<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># 입력한 비밀번호를 암호화한다.</span>\n        member_pw <span class=\"token operator\">=</span> bcrypt<span class=\"token punctuation\">.</span>hashpw<span class=\"token punctuation\">(</span>\n          data<span class=\"token punctuation\">[</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          bcrypt<span class=\"token punctuation\">.</span>gensalt<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># 미리 저장한 휴대전화번호로 유저를 특정해준 뒤</span>\n        Member<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>\n          member_phone<span class=\"token operator\">=</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'phoneNumber'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span> <span class=\"token comment\"># 나머지 정보를 저장한다.</span>\n          member_email     <span class=\"token operator\">=</span> member_email<span class=\"token punctuation\">,</span>\n          member_pw        <span class=\"token operator\">=</span> member_pw<span class=\"token punctuation\">,</span>\n          member_nickname  <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'nickname'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># [1, 2] 형태로 들어온 약관 id값을 받아 회원과 약관의 중간테이블에 회원 id와 함께 저장했다.</span>\n        <span class=\"token comment\"># 중간테이블에 데이터가 저장됐다는 것이 곧 약관에 동의했다는 의미다.</span>\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n          MemberTermsManagement<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>\n            member_idx_id <span class=\"token operator\">=</span> Member<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>\n              member_email<span class=\"token operator\">=</span>member_email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>member_idx<span class=\"token punctuation\">,</span>\n            terms_management_idx_id <span class=\"token operator\">=</span> TermsManagement<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>\n              terms_management_idx<span class=\"token operator\">=</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'termsId'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>terms_management_idx\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> ValidationError<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>status<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> KeyError<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> JsonResponse<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'message'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'Invalid key'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"네이버-클라우드-플랫폼-sms-발송-api-이용하기\" style=\"position:relative;\"><a href=\"#%EB%84%A4%EC%9D%B4%EB%B2%84-%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C-%ED%94%8C%EB%9E%AB%ED%8F%BC-sms-%EB%B0%9C%EC%86%A1-api-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"네이버 클라우드 플랫폼 sms 발송 api 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>네이버 클라우드 플랫폼 SMS 발송 API 이용하기</h3>\n<p><a href=\"https://apidocs.ncloud.com/ko/common/ncpapi/#API-%ED%98%B8%EC%B6%9C%ED%95%98%EA%B8%B0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NAVER CLOUD PLATFORM API 사용 가이드</a><br>\n<a href=\"https://apidocs.ncloud.com/ko/ai-application-service/sens/sms_v2/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SMS API v2 가이드</a></p>\n<p>카페24 API 흐름과 큰 틀에서는 같다. 네이버 클라우드 플랫폼은 Python 코드 예시도 있고 참고할 블로그도 많아서 카페24보다는 수월했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SMSVerificationView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">send_verification</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> phone_number<span class=\"token punctuation\">,</span> verification_number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 네이버 클라우드 플랫폼에 가입하면 발급해주는 serviceId를 입력해서 sms를 보내는 주소를 완성해준다.</span>\n    SMS_URL    <span class=\"token operator\">=</span> <span class=\"token string\">'https://sens.apigw.ntruss.com/sms/v2/services/{serviceId}/messages'</span>\n    <span class=\"token comment\"># time.time()*1000은 1970년 1월 1일 00:00:00 협정 세계시(UTC)부터의 경과 시간을</span>\n    <span class=\"token comment\"># 밀리초(Millisecond)단위로 나타낸 것</span>\n    <span class=\"token comment\"># API Gateway 서버와 시간 차가 5분 이상 나는 경우 유효하지 않은 요청으로 처리하기 위해 필요하다</span>\n    timestamp  <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># serviceId와 마찬가지로 클라우드 플랫폼 가입자마다 다른 고유 secret key</span>\n    secret_key <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>AUTH_SECRET_KEY<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n    \n    method <span class=\"token operator\">=</span> <span class=\"token string\">'POST'</span>\n    uri    <span class=\"token operator\">=</span> <span class=\"token string\">'/sms/v2/services/{serviceId}/messages'</span>\n    message    <span class=\"token operator\">=</span> method <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> uri <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span> <span class=\"token operator\">+</span> timestamp <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span> <span class=\"token operator\">+</span> AUTH_ACCESS_KEY\n    \n    <span class=\"token comment\"># message 형태를 풀어쓰면 아래와 같다.</span>\n    <span class=\"token triple-quoted-string string\">'''\n    GET /photos/puppy.jpg?query1=&amp;query2\n    {timeStamp}\n    {accessKey}\n    '''</span>\n    <span class=\"token comment\"># 암호화하기 위해 bytes type으로 인코딩한다.</span>\n    message    <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 위에서 생성한 StringToSign(message)를 HmacSHA256 알고리즘으로 암호화한 후</span>\n    <span class=\"token comment\"># base64로 인코딩해서 signingKey를 만든다.</span>\n    signingKey <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>\n      hmac<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span>secret_key<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> digestmod<span class=\"token operator\">=</span>hashlib<span class=\"token punctuation\">.</span>sha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># 요청 헤더</span>\n    headers    <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">'Content-Type'</span>             <span class=\"token punctuation\">:</span> <span class=\"token string\">'application/json; charset=utf-8'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'x-ncp-apigw-timestamp'</span>    <span class=\"token punctuation\">:</span> timestamp<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'x-ncp-iam-access-key'</span>     <span class=\"token punctuation\">:</span> AUTH_ACCESS_KEY<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'x-ncp-apigw-signature-v2'</span> <span class=\"token punctuation\">:</span> signingKey<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># 요청 바디</span>\n    body       <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\"># 장문 문자라면 'LMS'</span>\n      <span class=\"token string\">'type'</span>        <span class=\"token punctuation\">:</span> <span class=\"token string\">'SMS'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'contentType'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'COMM'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'countryCode'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'82'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\"># 카페 24와 마찬가지로 주요 정보는 my_settings.py에 저장했고</span>\n      <span class=\"token comment\"># settings.py와 연결해 그곳에서 끌어온다.</span>\n      <span class=\"token string\">'from'</span>        <span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>SMS_SEND_PHONE_NUMBER<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'content'</span>     <span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'인증번호 [</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>verification_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">]를 입력해주세요.'</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'messages'</span>    <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">'to'</span> <span class=\"token punctuation\">:</span> phone_number\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># 만든 바디를 json 형태로 변환한 뒤</span>\n    encoded_data <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 헤더와 함께 post 메소드로 SMS 전송 url에 요청을 보낸다.</span>\n    res          <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>SMS_URL<span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>encoded_data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> HttpResponse<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># 유저 휴대전화번호를 받아 인증번호를 생성하는 과정은 카페24 post 메소드와 동일</span>\n  <span class=\"token comment\"># 코드 이하 생략</span></code></pre></div>","fields":{"slug":"/posts/til61","tagSlugs":["/tag/til/","/tag/open-api/","/tag/verification/"]},"frontmatter":{"date":"2020-08-09T22:09:32","description":"카페24, 네이버 클라우드 플랫폼 Open API 이용하기","tags":["til","open-api","verification"],"title":"Open API를 이용한 회원가입 문자인증 기능 구현","socialImage":"/naon.png"}}},"pageContext":{"slug":"/posts/til61"}}}